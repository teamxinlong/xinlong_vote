<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í—ˆì”¬ë¡± ë§ˆê°¤ ìì²´ì œì‘ íˆ¬í‘œ ì§‘ê³„ ì‹œìŠ¤í…œ (PC)</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    #chatbox { height: 48vh; overflow-y: auto; }
    pre { white-space: pre; }
    .btn { cursor: pointer; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .editable-code { outline: none; border-bottom: 1px dashed #cbd5e1; }
    .editable-code:focus { background: #fff7ed; border-bottom-color: #fb923c; }
    /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì—†ì´ ë³´ê¸° ì¢‹ê²Œ: ì…€ ì•ˆì—ì„œ ìë™ ì¤„ë°”ê¿ˆ */
    td, th { word-break: break-all; }
    /* ì‘ì—…ìš© ìº”ë²„ìŠ¤ ìˆ¨ê¹€ */
    #workCanvas { position:absolute; left:-9999px; top:-9999px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <h1 class="text-2xl font-bold mb-4">ğŸ± í—ˆì”¬ë¡± ë§ˆê°¤ ìì²´ì œì‘ íˆ¬í‘œ ì§‘ê³„ ì‹œìŠ¤í…œ(PC)ğŸ’» âœ…</h1>

  <!-- ì±„íŒ… -->
  <div id="chatbox" class="w-full max-w-xl bg-white p-4 rounded shadow space-y-4 mb-4"></div>

  <!-- ì…ë ¥ì°½ (ì—”í„°/ë²„íŠ¼ ëª¨ë‘ ì§€ì›) -->
  <div class="w-full max-w-xl">
    <form id="chatForm" class="flex items-center space-x-2">
      <input type="text" id="chatInput" placeholder="ê³ ìœ ë²ˆí˜¸(ex-aa0001) ì…ë ¥ ë˜ëŠ” ì¸ì¦ìƒ·ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." class="flex-grow px-3 py-2 border rounded" autocomplete="off"/>
      <button type="submit" id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded btn">ì…ë ¥</button>
    </form>
  </div>

  <!-- ê²€ìˆ˜ ë©”ì‹œì§€ ë²„íŠ¼ -->
  <div class="w-full max-w-xl flex gap-2 mt-3">
    <button id="btnAssignDone" class="flex-1 bg-purple-600 text-white px-3 py-2 rounded btn">ê³ ìœ ë²ˆí˜¸ ë¶€ì—¬+ê²€ìˆ˜ ì™„ë£Œ</button>
    <button id="btnDone" class="flex-1 bg-green-600 text-white px-3 py-2 rounded btn">ê²€ìˆ˜ ì™„ë£Œ</button>
  </div>

  <!-- ê²°ê³¼ í…Œì´ë¸” -->
  <div id="resultPanel" class="w-full max-w-xl mt-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-gray-700">ê³ ìœ ë²ˆí˜¸: <span id="assignLabel" class="mono font-semibold">ë¯¸ì„¤ì •</span></div>
      <button id="copyAllBtn" class="text-xs px-3 py-1 rounded border btn">ì „ì²´ ë³µì‚¬</button>
    </div>
    <div class="bg-white rounded shadow overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">ê³ ìœ ë²ˆí˜¸</th>
            <th class="px-3 py-2 text-left">ë‚ ì§œ</th>
            <th class="px-3 py-2 text-left">ì‹œê°„</th>
            <th class="px-3 py-2 text-left">ì‹œë¦¬ì–¼ë„˜ë²„</th>
          </tr>
        </thead>
        <tbody id="resultTbody">
          <tr><td class="px-3 py-2 text-gray-400" colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì‘ì—…ìš© ìº”ë²„ìŠ¤ -->
  <canvas id="workCanvas"></canvas>

  <script>
  (function(){
    // ===== ë””ë²„ê·¸ ì—ëŸ¬ í‘œì‹œ =====
    window.addEventListener('error', (e)=>{
      const box = document.getElementById('chatbox'); if(!box) return;
      const div = document.createElement('div');
      div.className='text-right';
      div.innerHTML='<div class="inline-block p-2 rounded shadow bg-red-100 text-red-800"><strong>ğŸ¤– ì‹œìŠ¤í…œ:</strong><br><pre style="white-space:pre-wrap">'+ String(e.error||e.message) +'</pre></div>';
      box.appendChild(div);
    });

    // ===== DOM =====
    const chatbox = document.getElementById('chatbox');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const assignLabel = document.getElementById('assignLabel');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const resultTbody = document.getElementById('resultTbody');
    const btnAssignDone = document.getElementById('btnAssignDone');
    const btnDone = document.getElementById('btnDone');
    const workCanvas = document.getElementById('workCanvas');
    const wctx = workCanvas.getContext('2d');

    // ===== ìƒíƒœ =====
    let currentAssign = null;            // 'AA0001'
    const rows = [];                     // { assign, date, time, code, hash }
    const seenHashes = new Set();        // ì¤‘ë³µ ì´ë¯¸ì§€ ë°©ì§€
    let worker = null;                   // Tesseract ì¬ì‚¬ìš©

    // ===== ìœ í‹¸ =====
    async function copyToClipboard(text){
      try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); return true; } }catch(_){}
      const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
      document.body.removeChild(ta); return ok;
    }
    function appendMessage(sender, content, {plainText=false, copyText=null}={}){
      const msg=document.createElement('div');
      msg.className= sender==='user' ? 'text-left' : 'text-right';
      const wrap=document.createElement('div');
      wrap.className='inline-block p-2 rounded shadow ' + (sender==='user'?'bg-blue-100 text-blue-900':'bg-gray-200 text-gray-800');
      const header=document.createElement('div');
      header.className='flex items-center gap-2 mb-1';
      const label=document.createElement('strong');
      label.textContent= sender==='user' ? 'ğŸ‘¤ ìœ ì €:' : 'ğŸ¤– ì‹œìŠ¤í…œ:';
      header.appendChild(label);
      if(sender==='bot' && copyText){
        const b=document.createElement('button');
        b.className='ml-2 text-xs px-2 py-1 rounded border btn';
        b.textContent='ë³µì‚¬';
        b.onclick=async()=>{ const ok=await copyToClipboard(copyText); b.textContent=ok?'ë³µì‚¬ë¨':'ë³µì‚¬ì‹¤íŒ¨'; setTimeout(()=>b.textContent='ë³µì‚¬',1500); };
        header.appendChild(b);
      }
      wrap.appendChild(header);
      if(plainText){ const pre=document.createElement('pre'); pre.textContent=content; wrap.appendChild(pre); }
      else{ const div=document.createElement('div'); div.innerHTML=content; wrap.appendChild(div); }
      msg.appendChild(wrap); chatbox.appendChild(msg); chatbox.scrollTop=chatbox.scrollHeight;
    }
    function parseAssign(text){
      const s=(text||'').trim();
      return /^[A-Za-z]{2}\d{4}$/.test(s) ? s.toUpperCase() : null;
    }
    function setAssign(assign){
      currentAssign = (assign||'').toUpperCase();
      assignLabel.textContent = currentAssign || 'ë¯¸ì„¤ì •';
      rows.length = 0; renderTable();
    }
    function addRow(date,time,code,hash){
      rows.push({assign:currentAssign,date,time,code,hash});
      renderTable();
    }
    function renderTable(){
      if(!rows.length){ resultTbody.innerHTML='<tr><td class="px-3 py-2 text-gray-400" colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
      resultTbody.innerHTML = rows.map((r,i)=>`
        <tr class="border-t">
          <td class="px-3 py-2 mono">${r.assign}</td>
          <td class="px-3 py-2 mono">${r.date}</td>
          <td class="px-3 py-2 mono">${r.time||''}</td>
          <td class="px-3 py-2 mono editable-code" contenteditable="true" data-index="${i}" spellcheck="false">${r.code}</td>
        </tr>
      `).join('');
    }
    // ì¸ë¼ì¸ ìˆ˜ì • ì €ì¥
    resultTbody.addEventListener('keydown',(e)=>{
      const el=e.target.closest('.editable-code'); if(!el) return;
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
    });
    resultTbody.addEventListener('blur',(e)=>{
      const el=e.target.closest('.editable-code'); if(!el) return;
      const i=parseInt(el.dataset.index,10);
      const v=(el.innerText||'').trim();
      if(!Number.isNaN(i) && rows[i] && v){ rows[i].code=v; } else if(rows[i]) { el.innerText=rows[i].code; }
    }, true);

    copyAllBtn.onclick = async ()=>{
      const tsv = rows.map(r=>`${r.assign}\t${r.date}\t${r.time||''}\t${r.code}`).join('\n');
      const ok = await copyToClipboard(tsv);
      const old = copyAllBtn.textContent; copyAllBtn.textContent = ok?'ë³µì‚¬ë¨':'ë³µì‚¬ì‹¤íŒ¨';
      setTimeout(()=>copyAllBtn.textContent=old,1500);
    };

    // ===== ê²€ìˆ˜ ë©”ì‹œì§€ ìƒì„± =====
    function buildDateCountsLine(){
      const map = new Map(); // date -> count
      for(const r of rows){ map.set(r.date, (map.get(r.date)||0)+1); }
      const parts = [...map.entries()]
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([d,c])=>`${d.slice(5)} ${c}í‘œ`);
      const total = rows.length;
      return { line: parts.join(', '), total };
    }
    function emitMessage(withAssign){
      if(!rows.length || !currentAssign){ appendMessage('bot','ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const { line, total } = buildDateCountsLine();
      const aa = currentAssign.toUpperCase();
      const msg = withAssign
        ? `ì”¬ë¡±ì´ì—ê²Œ ì†Œì¤‘í•œ íˆ¬í‘œ ê°ì‚¬í•©ë‹ˆë‹¤ â¤\në¶€ì—¬ëœ ê³ ìœ ë²ˆí˜¸ëŠ” ${aa}ì…ë‹ˆë‹¤.\n${line}\nì´ ${total}í‘œ ì§‘ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜ºâ¤`
        : `ì”¬ë¡±ì´ì—ê²Œ ì†Œì¤‘í•œ íˆ¬í‘œ ê°ì‚¬í•©ë‹ˆë‹¤ â¤\n${aa}ë‹˜, ${line}\nì´ ${total}í‘œ ì§‘ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜ºâ¤`;
      appendMessage('bot', msg, { plainText:true, copyText: msg });
    }
    btnAssignDone.onclick = ()=>emitMessage(true);
    btnDone.onclick       = ()=>emitMessage(false);

    // ===== í…ìŠ¤íŠ¸ ì…ë ¥ -> ë¶€ì—¬ë²ˆí˜¸ =====
    function handleSend(){
      const text=chatInput.value.trim(); if(!text) return;
      appendMessage('user', text); chatInput.value='';
      const assign = parseAssign(text);
      if(assign){ setAssign(assign); appendMessage('bot', `ê³ ìœ ë²ˆí˜¸ ${assign} ì…ë‹ˆë‹¤.`); }
      else{ appendMessage('bot','ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.'); }
    }
    chatForm.addEventListener('submit', (e)=>{ e.preventDefault(); handleSend(); });

    // ===== ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° =====
    window.addEventListener('paste', async (e)=>{
      const items = e.clipboardData?.items || [];
      for(const it of items){
        if(it.kind==='file' && it.type.startsWith('image/')){
          const file = it.getAsFile();
          const url = URL.createObjectURL(file);
          appendMessage('user', `<img src="${url}" class="max-w-xs mt-1 rounded border shadow">`);
          if(!currentAssign){ appendMessage('bot','ë¨¼ì € ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) <b>AA0001</b>'); continue; }

          const hash = await sha256Hex(file);
          if(seenHashes.has(hash)){ appendMessage('bot','ì¤‘ë³µëœ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.'); continue; }

          const r = await ocrWithTesseract(file);
          const codeOnly = (r.voteNo||'').replace(/^No\.?\s*/i,'');
          const line = `${r.voteDate||'âŒ'}\t${r.voteTime||'âŒ'}\t${codeOnly||'âŒ'}`;
          appendMessage('bot', line, { plainText:true, copyText: line });

          if(r.voteDate && r.voteTime && codeOnly){
            addRow(r.voteDate, r.voteTime, codeOnly, hash);
            seenHashes.add(hash);
          }
        }
      }
    });

    // ===== OCR ìœ í‹¸(ì „ì²˜ë¦¬/ROI) =====
    function toHalfwidth(str){
      return str.replace(/[\uFF01-\uFF5E]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\u3000/g,' ');
    }
    function normalizePunct(str){
      return str.replace(/[:ï¼š]/g,':').replace(/[ï¼Â·ã€‚]/g,'.').replace(/[ï¼]/g,'/').replace(/[ï¼â€“â€”]/g,'-').replace(/[,ï¼Œ]/g,',');
    }
    function fixDigitLookalikes(str){
      let prev;
      do{
        prev=str;
        str=str
          .replace(/(\d)[Oo](\d)/g,'$10$2')
          .replace(/(\d)[lI](\d)/g,'$11$2')
          .replace(/(\d)[Ss](\d)/g,'$15$2')
          .replace(/([:.\-ì‹œhH])[Oo](\d)/g,'$10$2')
          .replace(/(\d)[Oo]([:.\-ì‹œhH])/g,'$10$2')
          .replace(/\b[Oo](\d)/g,'0$1')
          .replace(/(\d)[Oo]\b/g,'$10');
      }while(str!==prev);
      return str;
    }
    function preprocessCrop(img, x, y, w, h, scale=2, strong=false){
      const sw = Math.max(1, Math.floor(w*scale));
      const sh = Math.max(1, Math.floor(h*scale));
      workCanvas.width = sw; workCanvas.height = sh;
      wctx.drawImage(img, x, y, w, h, 0, 0, sw, sh);
      // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ + ëª…ì•”ê°•ì¡° + ì´ì§„í™”
      const imgData = wctx.getImageData(0,0,sw,sh);
      const d = imgData.data;
      const contrast = strong ? 1.8 : 1.4; // 1 = ì›ë³¸
      const threshold = strong ? 180 : 200; // ë°ì„ìˆ˜ë¡ ê¸€ì ì„ ëª…
      for(let i=0;i<d.length;i+=4){
        // luminance
        let g = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        // contrast
        g = (g-128)*contrast + 128;
        // clamp
        g = g<0?0:g>255?255:g;
        // binarize
        const b = g > threshold ? 255 : 0;
        d[i]=d[i+1]=d[i+2]=b; d[i+3]=255;
      }
      wctx.putImageData(imgData,0,0);
      return workCanvas.toDataURL('image/png');
    }

    // ===== Tesseract =====
    async function getWorker(){
      if(worker) return worker;
      worker = await Tesseract.createWorker();
      await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
      await worker.setParameters({
        user_defined_dpi: '300',
        preserve_interword_spaces: '1'
      });
      return worker;
    }

    async function sha256Hex(file){
      const buf = await file.arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function parseDateTime(text){
      let t = fixDigitLookalikes(normalizePunct(toHalfwidth(text)));
      const lines = t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const whole = lines.join(' ');
      const reDT = /\b(20\d{2})[.\-\/]\s?(\d{1,2})[.\-\/]\s?(\d{1,2})\s+([01]?\d|2[0-3])\s*[:.ì‹œhH]\s*([0-5]\d)/i;
      const reD  = /\b(20\d{2})[.\-\/]\s?(\d{1,2})[.\-\/]\s?(\d{1,2})\b/;
      const reT1 = /\b([01]?\d|2[0-3])\s*[:ì‹œ]\s*([0-5]\d)\b/;
      const reT2 = /\b([01]?\d|2[0-3])\s*[.\-hH]\s*([0-5]\d)\b/;

      let m = whole.match(reDT);
      if(m) return {date:`${m[1]}.${String(m[2]).padStart(2,'0')}.${String(m[3]).padStart(2,'0')}`, time:`${String(m[4]).padStart(2,'0')}:${m[5]}`};

      // ë¼ì¸/ì¸ì ‘ ë¼ì¸ ë³´ê°•
      for(let i=0;i<lines.length;i++){
        const li = lines[i];
        let dm = li.match(reDT);
        if(dm) return {date:`${dm[1]}.${String(dm[2]).padStart(2,'0')}.${String(dm[3]).padStart(2,'0')}`, time:`${String(dm[4]).padStart(2,'0')}:${dm[5]}`};
        let d = li.match(reD);
        if(d){
          let t1 = li.match(reT1) || li.match(reT2) || (i+1<lines.length && (lines[i+1].match(reT1) || lines[i+1].match(reT2)));
          if(t1){ return {date:`${d[1]}.${String(d[2]).padStart(2,'0')}.${String(d[3]).padStart(2,'0')}`, time:`${String(t1[1]).padStart(2,'0')}:${t1[2]}`}; }
        }
      }
      return {date:'', time:''};
    }

    function parseSerial(text){
      // ê³µë°±/ê°œí–‰/ì´ìƒí•œ ë¬¸ì ì œê±° í›„ íŒ¨í„´ ì¬êµ¬ì„±
      let s = toHalfwidth(text);
      s = s.replace(/[â€“â€”]/g,'-');
      // ì¤„ë°”ê¿ˆê³¼ ìŠ¤í˜ì´ìŠ¤ ì œê±°í•´ì„œ í•œ ì¤„ë¡œ
      let single = s.replace(/\s+/g,'');
      // "No.M-" ì•ë’¤ë¡œë§Œ í—ˆìš© ë¬¸ì
      let m = single.match(/N[o0]\.?M[-_][A-Za-z0-9_-]{4,64}/i);
      if(!m){
        // ì—¬ìœ ë¡­ê²Œ ê¸ê³  ë‚˜ì„œ ì •ì œ
        const m2 = single.match(/N[o0]\.?M[-_][A-Za-z0-9_\-]+/i);
        if(m2){
          let core = m2[0].replace(/^N[o0]\.?M[-_]/i,'');
          core = core.replace(/[^A-Za-z0-9_-]/g,'');
          return 'No.M-' + core;
        }
        return '';
      }
      // ì •ê·œì‹ í†µê³¼ê°’ ì •ì œ
      const raw = m[0].replace(/^N[o0]\.?/i,'No.');
      const core = raw.replace(/^No\.?M[-_]/i,'').replace(/[^A-Za-z0-9_-]/g,'');
      return 'No.M-' + core;
    }

    async function ocrWithTesseract(file){
      const w = await getWorker();

      // ì´ë¯¸ì§€ ë¡œë“œ
      const url = typeof file==='string' ? file : URL.createObjectURL(file);
      const img = new Image(); img.src = url; await img.decode();
      const W = img.naturalWidth, H = img.naturalHeight;

      // --- ROI ì •ì˜(ë¹„ìœ¨ ê¸°ë°˜) ---
      // ë‚ ì§œ/ì‹œê°„: í•˜ë‹¨ ì˜¤ë¥¸ìª½ ë°´ë“œ
      const dtBands = [
        {x: Math.floor(W*0.10), y: Math.floor(H*0.55), w: Math.floor(W*0.80), h: Math.floor(H*0.14)},
        {x: Math.floor(W*0.08), y: Math.floor(H*0.50), w: Math.floor(W*0.84), h: Math.floor(H*0.20)}
      ];
      // ì‹œë¦¬ì–¼: ë§¨ ì•„ë˜ ë¼ì¸
      const snBands = [
        {x: Math.floor(W*0.06), y: Math.floor(H*0.78), w: Math.floor(W*0.88), h: Math.floor(H*0.18)},
        {x: Math.floor(W*0.04), y: Math.floor(H*0.72), w: Math.floor(W*0.92), h: Math.floor(H*0.24)}
      ];

      let voteDate='', voteTime='', voteNo='';

      // --- ë‚ ì§œ/ì‹œê°„ 2íŒ¨ìŠ¤ ---
      for(let i=0;i<dtBands.length && !(voteDate&&voteTime); i++){
        const b = dtBands[i];
        const prep = preprocessCrop(img, b.x,b.y,b.w,b.h, 2, i>0); // ë‘ë²ˆì§¸ íŒ¨ìŠ¤ ë” ê°•í•˜ê²Œ
        await w.setParameters({
          tessedit_pageseg_mode: 7,
          tessedit_char_whitelist: '0123456789:.- hHì‹œKST'
        });
        const { data:{ text: t } } = await w.recognize(prep);
        const dt = parseDateTime(t);
        voteDate ||= dt.date; voteTime ||= dt.time;
      }
      // ì „ì²´ì—ì„œ ë§ˆì§€ë§‰ ë³´ê°•
      if(!(voteDate&&voteTime)){
        await w.setParameters({
          tessedit_pageseg_mode: 6,
          tessedit_char_whitelist: '0123456789:.- hHì‹œKST'
        });
        const { data:{ text: t } } = await w.recognize(url);
        const dt = parseDateTime(t);
        voteDate ||= dt.date; voteTime ||= dt.time;
      }

      // --- ì‹œë¦¬ì–¼ 2íŒ¨ìŠ¤ ---
      for(let i=0;i<snBands.length && !voteNo; i++){
        const b = snBands[i];
        const prep = preprocessCrop(img, b.x,b.y,b.w,b.h, 2, true);
        await w.setParameters({
          tessedit_pageseg_mode: 7,
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789No.M-_ '
        });
        const { data:{ text: t } } = await w.recognize(prep);
        voteNo = parseSerial(t);
      }
      // ì „ì²´ í•˜ë‹¨ 1/3 ë³´ê°•
      if(!voteNo){
        const b = {x:0, y: Math.floor(H*0.66), w: W, h: Math.floor(H*0.34)};
        const prep = preprocessCrop(img, b.x,b.y,b.w,b.h, 2, true);
        await w.setParameters({
          tessedit_pageseg_mode: 6,
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789No.M-_ '
        });
        const { data:{ text: t } } = await w.recognize(prep);
        voteNo = parseSerial(t);
      }

      return { voteDate, voteTime, voteNo };
    }

  })();
  </script>
</body>
</html>
